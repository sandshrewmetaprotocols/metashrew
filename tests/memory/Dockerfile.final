# Stage 1: Build with NO memory limits
FROM rust:1.86 as builder

RUN apt-get update && apt-get install -y \
    build-essential \
    clang \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /metashrew
COPY . .

# Add wasm32 target
RUN rustup target add wasm32-unknown-unknown --toolchain 1.86.0

# Build metashrew-memory-stress WASM (for our memory test)
RUN cargo build --target wasm32-unknown-unknown --release -p metashrew-memory-stress

# Build tests (this will trigger build.rs which builds metashrew_minimal.wasm)
# Just let it build everything naturally
RUN cargo test --lib --no-run

# Find the test binary
RUN cp $(find target/debug/deps -name "metashrew_tests-*" -type f -executable | head -1) /metashrew_tests

# Stage 2: Runtime with same glibc
FROM rust:1.86-slim

WORKDIR /metashrew
RUN mkdir -p target/wasm32-unknown-unknown/release

# Copy WASM module
COPY --from=builder /metashrew/target/wasm32-unknown-unknown/release/metashrew_memory_stress.wasm \
    target/wasm32-unknown-unknown/release/

# Copy test binary
COPY --from=builder /metashrew_tests ./metashrew_tests
RUN chmod +x metashrew_tests

ENV RUST_LOG=info

CMD ["./metashrew_tests", "memory_stress_normal_environment", "--ignored", "--nocapture"]
