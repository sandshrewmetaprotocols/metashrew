# Stage 1: Build everything with no memory limits
FROM rust:1.86 as builder

RUN apt-get update && apt-get install -y \
    build-essential \
    clang \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /metashrew
COPY . .

# Add wasm32 target
RUN rustup target add wasm32-unknown-unknown --toolchain 1.86.0

# Build metashrew-minimal WASM first (required by build.rs)
RUN cargo build --target wasm32-unknown-unknown --release -p metashrew-minimal

# Build metashrew-memory-stress WASM
RUN cargo build --target wasm32-unknown-unknown --release -p metashrew-memory-stress

# Now build the main library (this runs build.rs which needs metashrew_minimal.wasm)
RUN cargo build --lib

# Build tests
RUN cargo test --lib memory_determinism_test --no-run

# Find and copy the test binary to a known location
RUN cp $(find target/debug/deps -name "metashrew_tests-*" -type f -executable | head -1) /metashrew_tests

# Stage 2: Minimal runtime with same glibc
FROM rust:1.86-slim

WORKDIR /metashrew

# Create directory structure
RUN mkdir -p target/wasm32-unknown-unknown/release

# Copy WASM modules
COPY --from=builder /metashrew/target/wasm32-unknown-unknown/release/metashrew_memory_stress.wasm \
    target/wasm32-unknown-unknown/release/
COPY --from=builder /metashrew/target/wasm32-unknown-unknown/release/metashrew_minimal.wasm \
    target/wasm32-unknown-unknown/release/

# Copy test binary
COPY --from=builder /metashrew_tests ./metashrew_tests
RUN chmod +x metashrew_tests

ENV RUST_LOG=info

# Default: run memory stress test
CMD ["./metashrew_tests", "memory_stress_normal_environment", "--ignored", "--nocapture"]
