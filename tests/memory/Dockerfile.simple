FROM debian:bookworm-slim

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    libgcc-s1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /metashrew

# Create target directory structure
RUN mkdir -p target/wasm32-unknown-unknown/release

# Copy pre-built WASM module from staging
COPY tests/memory/bin/metashrew_memory_stress.wasm \
    ./target/wasm32-unknown-unknown/release/

# Copy pre-built test binary from staging
COPY tests/memory/bin/metashrew_tests ./metashrew_tests

# Make test binary executable
RUN chmod +x metashrew_tests

# Environment
ENV RUST_LOG=info

# Default command: run the memory stress test
CMD ["./metashrew_tests", "memory_stress_normal_environment", "--ignored", "--nocapture"]
